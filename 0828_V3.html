<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ebrainK</title>
    <script defer src="face-api.min.js"></script>
    <script defer src="script.js"></script>
</head>
<body>
<div>
    <button onclick="switchCamera()">切換鏡頭</button>
</div>
<video id="video" class="video" autoplay muted playsinline></video>

<div id="imageContainer"></div>

<script>
const video = document.getElementById("video");
        
Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri('./models'),
  faceapi.nets.faceLandmark68Net.loadFromUri('./models'),
  faceapi.nets.faceRecognitionNet.loadFromUri('./models'),
  faceapi.nets.faceExpressionNet.loadFromUri('./models')
]).then(startVideo)

// 切換鏡頭
function switchCamera() {
  if (videoElement.srcObject) {
    let videoTracks = video.srcObject.getVideoTracks();
    if (videoTracks.length > 0) {
      let currentTrack = videoTracks[0];
      let facingMode = currentTrack.getSettings().facingMode;

      const constraints = { video: {} };
      if (facingMode === "user") {
        constraints.video.facingMode = "environment"; // 切換到後鏡頭
      } else {
        constraints.video.facingMode = "user"; // 切換到前鏡頭
      }

      // 停止原本的視訊串流
      videoTracks.forEach(function (track) {
        track.stop();
      });

      // 確保瀏覽器支援 MediaDevices API
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // 取得新的視訊串流
        navigator.mediaDevices
          .getUserMedia(constraints)
          .then(function (stream) {
            video.srcObject = stream;
          })
          .catch(function (error) {
            console.error("無法取得視訊串流:", error);
            alert(
              "您使用的瀏覽器不支援視訊串流，請使用其他瀏覽器，再重新開啟頁面！"
            );
          });
      } else {
        alert(
          "您使用的瀏覽器不支援視訊串流，請使用其他瀏覽器，再重新開啟頁面！"
        );
      }
    }
  }
}

function startCam() {
  // 手機前後鏡頭切換 前鏡頭為 'user'，後鏡頭為 'environment'
  const constraints = { video: { facingMode: "user" } };
  // 確保瀏覽器支援MediaDevices API
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    // 取得視訊串流
    navigator.mediaDevices
      .getUserMedia(constraints)
      .then(function (stream) {
        // iOS 手機使用時，必須增加的屬性
        video.setAttribute("autoplay", "");
        video.setAttribute("muted", "");
        video.setAttribute("playsinline", "");

        video.srcObject = stream;
        startFaceDetection();
      })   
      .catch(function (error) {
                    console.log("無法取得視訊串流：", error);
                    alert(
                        "您使用的瀏覽器不支援視訊串流，請使用其他瀏覽器，再重新開啟頁面！"
                    );
                });
        } else {
            alert("您使用的瀏覽器不支援視訊串流，請使用其他瀏覽器，再重新開啟頁面！");
        }
    }
    function startFaceDetection() {
        videoElement.addEventListener('play', () => {
            const canvas = faceapi.createCanvasFromMedia(videoElement);
            document.body.append(canvas);
            const displaySize = { width: videoElement.width, height: videoElement.height };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(videoElement, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceExpressions();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                faceapi.draw.drawDetections(canvas, resizedDetections);
                faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
            }, 100);
        });
    }
// 初始執行函式
startCam();
    </script>
</body>
</html>
